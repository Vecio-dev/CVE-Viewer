<script>
    import Navbar from "$lib/navbar.svelte";
    import CVE_Preview from "$lib/cve-preview.svelte";
    import Loading from "$lib/loading.svelte";

    import "../app.css";
    import { onMount } from "svelte";

	export let data;

    export function getCVSSMetric(metrics) {
        const regexPattern = /^cvssMetricV(\d+)$/;

        for (const key in metrics) {
            if (metrics.hasOwnProperty(key) && regexPattern.test(key)) {
                return metrics[key];
            }
        }

        return null;
    }

    onMount(async () => {
        let cacheLifetime = 60000;
        let currentTime = new Date().getTime();

        let localData = localStorage.getItem("lastVuln");
        let isLocalDataValid = false;

        if (localData) {
            data = JSON.parse(localData);
            isLocalDataValid = currentTime - data.timestamp < cacheLifetime;
        } 
        
        if (!isLocalDataValid) {
            let currentGmt = new Date();
            let lastWeekGmt = new Date(currentGmt.getTime() - (7 * 24 * 60 * 60 * 1000));
    
            let currentGmtString = currentGmt.toISOString();
            let lastWeekGmtString = lastWeekGmt.toISOString();

            const res = await fetch(`https://services.nvd.nist.gov/rest/json/cves/2.0/?pubStartDate=${lastWeekGmtString}&pubEndDate=${currentGmtString}&resultsPerPage=51`);
            let req_data = await res.json();

            localStorage.setItem("lastVuln", JSON.stringify({ ...req_data, timestamp: currentTime }));
            data = req_data;
        }

        document.getElementById('searchInput')?.addEventListener('focus', function() {
            let search_bar = document.getElementById('search-bar');
            search_bar?.classList.remove('w-[405px]');
            search_bar?.classList.add('w-[1775px]');
        });

        document.getElementById('searchInput')?.addEventListener('blur', function() {
            let searchInput = document.getElementById('searchInput')?.value;
            if (searchInput) return;

            let search_bar = document.getElementById('search-bar');
            search_bar?.classList.remove('w-[1775px]');
            search_bar?.classList.add('w-[405px]');
        });

        let save_data = data;
        document.getElementById('searchInput')?.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                let searchInput = document.getElementById('searchInput')?.value;
                if (!searchInput) return;
                data = '';
                
                let params = {
                    cveId: '',
                    cvssV3Severity: '',
                    keywordSearch: '',
                    pubEndDate: '',
                }

                // cve;severity;keyword;date;
                let options = searchInput.split(' ');
                options.forEach(elem => {
                    let keys = elem.split(':');
                    if (keys[0] == 'cve') params.cveId = keys[1];
                    if (keys[0] == 'severity') params.cvssV3Severity = keys[1];
                    if (keys[0] == 'keyword') params.keywordSearch = keys[1];
                    if (keys[0] == 'date') params.pubEndDate = keys[1];
                });

                let queryString = '';
                for (let key in params) {
                    let value = params[`${key}`];
                    if (value) queryString += `${key}=${value}&`;
                }
                if (!queryString) return data = 'invalid_input';

                const res = await fetch(`https://services.nvd.nist.gov/rest/json/cves/2.0/?${queryString}`);
                if (res.status == 200) return data = await res.json();
                else return data = 'status_error';
            }
        });
    });
</script>

<svelte:head>
    <title>Home</title> 
</svelte:head>

<div class="body bg-my_zinc_600 flex flex-col min-h-screen">
    <div class="flex-grow">
        <div class="Frame1 w-[1920px] relative">
    
            <!-- NAVBAR -->
            <Navbar />
      
            <!-- SEARCH BAR -->
            <div class="Barra2Group w-[1800px] h-[92px] left-[60px] top-[170px] absolute">
                <div class="Barra2 w-[1800px] h-[92px] left-0 top-0 bg-my_neutral_700 rounded-[44px] shadow">
                    <div class="Rectangle13 w-[405px] h-[70px] left-[12px] top-[11px] absolute bg-my_zinc_700 rounded-[44px] transition-all" id="search-bar">
                        <div class="Search w-[175px] h-[42px] left-[50px] absolute text-my_gray_400 text-[40px] font-bold font-['Kaisei Opti']"><input id="searchInput" placeholder="Search..." style="all: unset; width: 1710px;"></div>
                    </div>
                </div>
            </div>
      
            <!-- CVE LIST -->
            { #if data.vulnerabilities }
                <div class="Group6 grid grid-cols-3 gap-y-[50px] w-[1800px] h-auto left-[60px] top-[378px] relative">
                    { #each data.vulnerabilities as elem }
                        <CVE_Preview id={elem.cve.id} description={elem.cve.descriptions[0].value} score={getCVSSMetric(elem.cve.metrics) ? getCVSSMetric(elem.cve.metrics)[0].cvssData.baseScore : null} />
                    { /each }
                </div>
            { :else if data == 'invalid_input' }
                <div class="flex flex-col items-center justify-center h-screen">
                    <div class="mt-[20px] text-my_gray_400 text-xl text-bold font-['Kaisei Opti']">Invalid Input</div>
                    <div class="mt-[10px] text-[20px] font-['Kaisei Opti']">
                        <span>
                            <a href="#" onclick="location.reload(); return false;"><button class="px-[20px] h-[50px] bg-my_indigo_600 rounded-lg">Back</button></a>
                        </span>
                        <span>
                            <a href="/info"><button class="px-[20px] h-[50px] bg-my_indigo_500 rounded-lg">Help</button></a>
                        </span>
                    </div>
                </div>
            { :else if data == 'status_error' }
                <div class="flex flex-col items-center justify-center h-screen">
                    <div class="mt-[20px] text-my_gray_400 text-xl text-bold font-['Kaisei Opti']">Didn't find anything...</div>
                    <div class="mt-[10px] text-[20px] font-['Kaisei Opti']">
                        <span>
                            <a href="#" onclick="location.reload(); return false;"><button class="px-[20px] h-[50px]    bg-my_indigo_600 rounded-lg">Back</button></a>
                        </span>
                        <span>
                            <a href="/info"><button class="px-[20px] h-[50px] bg-my_indigo_500 rounded-lg">Help</button></a>
                        </span>
                    </div>
                </div>
            { :else }
                <Loading />
            { /if }
        </div>
    </div>
    <div class="h-[500px]"></div>
</div>