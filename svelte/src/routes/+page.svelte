<script>
    import Navbar from "$lib/navbar.svelte";
    import CVE_Preview from "$lib/cve-preview.svelte";

    import "../app.css";
    import { onMount } from "svelte";

	export let data;

    export function getCVSSMetric(metrics) {
        const regexPattern = /^cvssMetricV(\d+)$/;

        for (const key in metrics) {
            if (metrics.hasOwnProperty(key) && regexPattern.test(key)) {
                return metrics[key];
            }
        }

        return null;
    }

    onMount(async () => {
        let currentGmt = new Date();
        let lastWeekGmt = new Date(currentGmt.getTime() - (7 * 24 * 60 * 60 * 1000));

        let currentGmtString = currentGmt.toISOString();
        let lastWeekGmtString = lastWeekGmt.toISOString();


        const res = await fetch(`https://services.nvd.nist.gov/rest/json/cves/2.0/?pubStartDate=${lastWeekGmtString}&pubEndDate=${currentGmtString}&resultsPerPage=30`);
        data = await res.json();
        console.log(data);

        data.vulnerabilities.forEach((elem, index) => {
            console.log(index)
            console.log(elem.cve.metrics)
            console.log("-----------");
        });
    });
</script>

<div class="body bg-my_zinc_600 flex flex-col min-h-screen">
    <div class="flex-grow">
        <div class="Frame1 w-[1920px] relative">
    
            <!-- NAVBAR -->
            <Navbar />
      
            <!-- SEARCH BAR -->
            <div class="Barra2Group w-[1800px] h-[92px] left-[60px] top-[170px] absolute">
                <div class="Barra2 w-[1800px] h-[92px] left-0 top-0 absolute bg-my_neutral_700 rounded-[44px] shadow"></div>
                <div class="Rectangle13 w-[405px] h-[70px] left-[12px] top-[11px] absolute bg-my_zinc_700 rounded-[44px]"></div>
                <div class="Search w-[175px] h-[42px] left-[50px] top-[14px] absolute text-my_gray_400 text-[40px] font-bold font-['Kaisei Opti']"><input placeholder="Search..." style="all: unset; width: 340px;"></div>
            </div>
      
            <!-- CVE LIST -->
            { #if data.vulnerabilities }
                <div class="Group6 grid grid-cols-3 gap-y-[50px] w-[1800px] h-auto left-[60px] top-[378px] relative">
                    { #each data.vulnerabilities as elem }
                        <CVE_Preview id={elem.cve.id} description={elem.cve.descriptions[0].value} score={getCVSSMetric(elem.cve.metrics) ? getCVSSMetric(elem.cve.metrics)[0].cvssData.baseScore : null} />
                    { /each }
                </div>
            { /if }
        </div>
    </div>
    <div class="h-[500px]"></div>
</div>

<style>
</style>
