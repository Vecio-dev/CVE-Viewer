<script>
    import Navbar from "$lib/navbar.svelte";
    import Loading from "$lib/loading.svelte";
    import { onMount } from "svelte";

    import "../../../app.css";

    /** @type {import('./$types').PageData} */
	  export let data;
    export let vuln;

    export function getCVSSMetric(metrics) {
        const regexPattern = /^cvssMetricV(\d+)$/;

        for (const key in metrics) {
            if (metrics.hasOwnProperty(key) && regexPattern.test(key)) {
                return metrics[key];
            }
        }

        return null;
    }

    export function getMetricInfo(value) {
      if (value < 5 && value > 0) return {color: "my_lime_400", label: "LOW"};
      else if (value >= 4 && value < 8) return { color: "my_orange_300", label: "MEDIUM" };
      else if (value >= 8 && value <= 10) return { color: "my_red_400", label: "CRITICAL" };
      else return { color: "my_gray_400", label: "" };
    }

    onMount(async () => {
      let cacheLifetime = 60000 * 60;
      let currentTime = new Date().getTime();

      let vuln_localData = localStorage.getItem(`${data.params}`);
      let isVuln_LocalDataValid = false;

      if (vuln_localData) {
        let vulnData = JSON.parse(vuln_localData);
        vuln = vulnData.vulnerabilities[0];
        isVuln_LocalDataValid = currentTime - vulnData.timestamp < cacheLifetime;
      }

      if (!isVuln_LocalDataValid) {
        const res = await fetch(`https://services.nvd.nist.gov/rest/json/cves/2.0/?cveId=${data.params}`);
        let req_data = await res.json();

        localStorage.setItem(`${data.params}`, JSON.stringify({ ...req_data, timestamp: currentTime }));
        vuln = req_data.vulnerabilities[0];
      }
    });

</script>

<svelte:head>
    <title>{ data.params }</title> 
</svelte:head>

<div class="body bg-my_zinc_600 flex flex-col min-h-screen ">
    <div class="flex-grow">
        <div class="Frame2 w-[1920px] relative">
          <!-- NAVBAR -->
          <Navbar />
    
          { #if vuln }
          <div class="IdDetail left-[75px] top-[224px] absolute text-black text-[40px] font-bold font-['Kaisei Opti']"><i class="fa fa-bug text-7xl"></i> { vuln.cve.id } Detail</div>
    
          <!-- Quick Info -->
          <div class="QuickInfoGroup w-80 h-[300px] left-[1533px] top-[150px] fixed">
            <div class="Rectangle17 w-80 h-[300px] left-0 top-0 absolute bg-my_neutral_700 rounded-[30px] shadow"></div>
            <div class="Rectangle16 w-[313px] h-[300px] left-0 top-0 absolute bg-my_neutral_700 rounded-[30px] shadow">
            </div>
            <div class="Barra2 w-[263px] h-[57px] left-[25px] top-[40px] absolute bg-my_zinc_700 rounded-[40px] shadow">
            </div>
            <div class="QuickInfo left-[65px] top-[47px] absolute text-my_gray_400 text-3xl font-bold font-['Kaisei Opti']">
              QUICK
              INFO</div>
            <div
              class="Text left-[28px] top-[124px] absolute text-my_indigo_500 underline text-xl font-bold font-['Kaisei Opti']">
              <div>
                <a href="#description">Description</a>
              </div>
              <div>
                <a href="#severity">Severity</a>
              </div>
              <div>
                <a href="#references">Refernces</a>
              </div>
              <div>
                <a href="#weakness">Weakness Enumeration</a>
              </div>
              <div>
                <a href="#configurations">Known Affected Software</a>
              </div>
            </div>
          </div>
    
          <!-- Description -->
          <div class="relative w-[1360px] min-h-[110px] left-[57px] top-[416px] bg-my_neutral_700 rounded-[44px] shadow">
            <div class="relative left-[30px] bottom-[50px]">
              <div class="Barra2 w-[299px] h-[57px] left-[7px] top-[10px] absolute bg-my_neutral_700 rounded-[40px] shadow">
              </div>
              <div class="Barra2 w-[299px] h-[57px] absolute bg-my_zinc_700 rounded-[40px] shadow"></div>
    
              <div id="description"
                class="Severity w-[202px] left-[70px] top-0 absolute text-my_gray_400 text-[35px] font-bold font-['Kaisei Opti']" style="scroll-margin-top: 130px;">
                Description</div>
            </div>
    
            <div class="Text text-my_gray_400 text-xl font-['Kaisei Opti'] w-fit p-5">
              { vuln.cve.descriptions[0].value }
            </div>
          </div>
    
          <!-- Severity -->
          <div class="Group1 w-[1309px] h-[542px] left-[57px] top-[500px] relative">
            <div class="relative left-[30px]">
              <div class="Barra2 w-[299px] h-[57px] left-[7px] top-[10px] absolute bg-my_neutral_700 rounded-[40px] shadow">
              </div>
              <div class="Barra2 w-[299px] h-[57px] absolute bg-my_zinc_700 rounded-[40px] shadow"></div>
    
              <div id="severity"
                class="Severity w-[202px] left-[90px] top-0 absolute text-my_gray_400 text-[35px] font-bold font-['Kaisei Opti']" style="scroll-margin-top: 130px;">
                Severity</div>
            </div>
    
            <div class="Barra2 w-[1301px] h-[483px] left-[8px] top-[59px] absolute bg-my_neutral_700 rounded-[40px] shadow">
            </div>
            <div class="Barra2 w-[1301px] h-[483px] left-0 top-[51px] absolute bg-my_neutral_700 rounded-[40px] shadow">
            </div>
            <div
              class="Rectangle18 w-[184.02px] h-[200px] left-[147.21px] top-[177px] absolute bg-{ getMetricInfo(getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].cvssData.baseScore : null).color } rounded-xl shadow">
            </div>
            <div
              class="Critical w-[227px] left-[170px] top-[324px] absolute text-black text-3xl font-bold font-['Kaisei Opti']">
              { getMetricInfo(getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].cvssData.baseScore : null).label }</div>
            <div
              class="Rectangle19 w-[184.02px] h-[200px] left-[558.49px] top-[177px] absolute bg-{ getMetricInfo(getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].impactScore : null).color } rounded-xl shadow">
            </div>
            <div
              class="Rectangle20 w-[184.02px] h-[200px] left-[969.77px] top-[177px] absolute bg-{ getMetricInfo(getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].exploitabilityScore : null).color } rounded-xl shadow">
            </div>
            <div
              class="Score w-[182px] h-[81px] left-[191px] top-[393px] absolute text-my_gray_400 text-[37px] font-bold font-['Kaisei Opti']">
              Score</div>
            <div
              class="Critical w-[179px] left-[585px] top-[324px] absolute text-black text-3xl font-bold font-['Kaisei Opti']">
              { getMetricInfo(getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].impactScore : null).label }</div>
            <div
              class="Critical w-[252px] left-[1000px] top-[324px] absolute text-black text-3xl font-bold font-['Kaisei Opti']">
              { getMetricInfo(getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].exploitabilityScore : null).label }</div>
            <div
              class="ImpactScore w-[305px] left-[537px] top-[393px] absolute text-my_gray_400 text-[37px] font-bold font-['Kaisei Opti']">
              Impact Score</div>
            <div
              class="Exploitability w-[277px] left-[933px] top-[393px] absolute text-my_gray_400 text-[37px] font-bold font-['Kaisei Opti']">
              Exploitability</div>
            <div
              class="8 w-[145px] left-[165px] top-[209px] absolute flex justify-center items-center text-black text-[75px] font-bold font-['Kaisei Opti']">
              { getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].cvssData.baseScore : "N/A" }</div>
            <div
              class="8 w-[162px] left-[570px] top-[209px] absolute flex justify-center items-center text-black text-[75px] font-bold font-['Kaisei Opti']">
              { getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].impactScore : "N/A" }</div>
            <div
              class="8 w-[138px] left-[990px] top-[209px] absolute flex justify-center items-center text-black text-[75px] font-bold font-['Kaisei Opti']">
              { getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].exploitabilityScore : "N/A" }</div>
          </div>
    
          <!-- Refernces to Advisories, Solutions, and Tools -->
          <div class="relative w-[1360px] min-h-[110px] left-[57px] top-[616px] bg-my_neutral_700 rounded-[44px] shadow">
            <div class="relative left-[30px] bottom-[50px]">
    
              <div class="Barra2 w-[850px] h-[57px] left-[7px] top-[10px] absolute bg-my_neutral_700 rounded-[40px] shadow">
              </div>
              <div class="Barra2 w-[850px] h-[57px] absolute bg-my_zinc_700 rounded-[40px] shadow"></div>
    
              <div id="references"
                class="Severity min-w-[202px] left-[70px] top-0 absolute text-my_gray_400 text-[35px] font-bold font-['Kaisei Opti']" style="scroll-margin-top: 130px;">
                Refernces to Advisories, Solutions, and Tools</div>
            </div>
    
            <div class="Text text-my_gray_400 text-xl font-['Kaisei Opti'] w-fit p-5">
              { #if vuln.cve.references }
              <table class="table-fixed w-full border-solid border-2 border-black">
                <thead class="border-solid border-2 border-black h-[40px]">
                  <tr>
                    <th class="border-solid border-2 border-black">Hyperlink</th>
                    <th>Resource</th>
                  </tr>
                </thead>
                <tbody class="h-[50px]">
                  { #each vuln.cve.references as elem }
                  <tr>
                    <td class="border-solid border-2 border-black px-2"><a class="text-my_indigo_500 underline" href="{ elem.url }" target="_blank" rel="noopener noreferrer">{ elem.url }</a></td>
                    <td class="px-2 border-solid border-2 border-black"><div>
                      { #if elem.tags }
                        
                      { #each elem.tags as tag }
                      <span class="p-[1px] px-[3px] mr-[6px] bg-my_gray_400 text-black rounded-md">{ tag }</span>
                      {/each }
                      {/if }
                    </div></td>
                  </tr>
                  { /each }
                </tbody>
              </table>
              { :else }
              <div class="Text text-my_gray_400 text-xl font-['Kaisei Opti'] w-fit p-5">Data not available yet.</div>
              { /if }
            </div>
          </div>
    
          <!-- Weakness Enumeration -->
          <div class="relative w-[1360px] min-h-[110px] left-[57px] top-[732px] bg-my_neutral_700 rounded-[44px] shadow">
            <div class="relative left-[30px] bottom-[50px]">
              <div class="Barra2 w-[500px] h-[57px] left-[7px] top-[10px] absolute bg-my_neutral_700 rounded-[40px] shadow">
              </div>
              <div class="Barra2 w-[500px] h-[57px] absolute bg-my_zinc_700 rounded-[40px] shadow"></div>
    
              <div id="weakness"
                class="Severity min-w-[202px] left-[70px] top-0 absolute text-my_gray_400 text-[35px] font-bold font-['Kaisei Opti']" style="scroll-margin-top: 130px;">
                Weakness Enumeration</div>
            </div>
    
            <div class="Text text-my_gray_400 text-xl font-['Kaisei Opti'] w-fit p-5">
              { #if vuln.cve.weaknesses }
                
              <table class="table-fixed w-full border-solid border-2 border-black">
                <thead class="border-solid border-2 border-black h-[40px]">
                  <tr>
                    <th class="border-solid border-2 border-black">CWE-ID</th>
                    <th class="border-solid border-2 border-black">Source</th>
                    <th>Type</th>
                  </tr>
                </thead>
                <tbody class="h-[50px]">
                  { #each vuln.cve.weaknesses as elem }
                  <tr>
                    <td class="border-solid border-2 border-black px-2"><a class="text-my_indigo_500 underline" href="https://cwe.mitre.org/data/definitions/{ (elem.description[0].value).match(/\d+/) ? (elem.description[0].value).match(/\d+/)[0] : elem.description[0].value }.html" target="_blank" rel="noopener noreferrer">{ elem.description[0].value }</a></td>
                    <td class="px-2 border-solid border-2 border-black">{ elem.source }</td>
                    <td class="px-2 border-solid border-2 border-black">{ elem.type }</td>
                  </tr>
                  { /each }
                </tbody>
              </table>
              { :else }
              <div class="Text text-my_gray_400 text-xl font-['Kaisei Opti'] w-fit p-5">Data not available yet.</div>
              { /if }
            </div>
          </div>
    
          <!-- Known Affected Software Configurations -->
          <div class="relative w-[1360px] min-h-[110px] left-[57px] top-[848px] bg-my_neutral_700 rounded-[44px] shadow">
            <div class="relative left-[30px] bottom-[50px]">
              <div class="Barra2 w-[800px] h-[57px] left-[7px] top-[10px] absolute bg-my_neutral_700 rounded-[40px] shadow">
              </div>
              <div class="Barra2 w-[800px] h-[57px] absolute bg-my_zinc_700 rounded-[40px] shadow"></div>
    
              <div id="configurations"
                class="Severity min-w-[202px] left-[70px] top-0 absolute text-my_gray_400 text-[35px] font-bold font-['Kaisei Opti']" style="scroll-margin-top: 130px;">
                Known Affected Software Configurations</div>
            </div>
    
            <div class="Text text-my_gray_400 text-xl font-['Kaisei Opti'] w-fit p-5">
              { #if vuln.cve.configurations }
              { #if vuln.cve.configurations[0] }  
              <table class="table-fixed w-full border-solid border-2 border-black">
                <thead class="border-solid border-2 border-black h-[40px]">
                  <tr>
                    <th class="border-solid border-2 border-black">Configuration</th>
                    <th>Up to ({ vuln.cve.configurations[0].nodes[0].cpeMatch[0].versionEndExcluding ? "Excluding" : "Including" })</th>
                  </tr>
                </thead>
                <tbody class="h-[50px]">
                  { #each vuln.cve.configurations[0].nodes[0].cpeMatch as cpe }
                  <tr>
                    <td class="border-solid border-2 border-black px-2">{ cpe.criteria }</td>
                    <td class="px-2 border-solid border-2 border-black">{ cpe.versionEndExcluding ? cpe.versionEndExcluding : cpe.versionEndIncluding }</td>
                  </tr>
                  { /each }
                </tbody>
              </table>
              {/if }

              { #if vuln.cve.configurations[1] }
              <table class="table-fixed mt-[30px] w-full border-solid border-2 border-black">
                <thead class="border-solid border-2 border-black h-[40px]">
                  <tr>
                    <th class="border-solid border-2 border-black w-[800px]">Configuration</th>
                    <th class="border-solid border-2 border-black">From (including)</th>
                    <th class="border-solid border-2 border-black">Up to (including)</th>
                  </tr>
                </thead>
                <tbody class="h-[90px]">
                  { #each vuln.cve.configurations[1].nodes[0].cpeMatch as cpe }
                  <tr>
                    <td class="border-solid border-2 border-black px-2">{ cpe.criteria }</td>
                    <td class="px-2 border-solid border-2 border-black">{ cpe.versionStartIncluding ? cpe.versionStartIncluding : "" }</td>
                    <td class="px-2 border-solid border-2 border-black">{ cpe.versionEndIncluding ? cpe.versionEndIncluding : "" }</td>
                  </tr>
                  {/each }
                </tbody>
              </table>
              { /if }
              { :else }
              <div class="Text text-my_gray_400 text-xl font-['Kaisei Opti'] w-fit p-5">Data not available yet.</div>
              { /if }
            </div>
          </div>
          { :else }
          <Loading />
          { /if }
        </div>
      </div>
      <div class="h-[1000px]"></div>
</div>