<script>
    import Navbar from "$lib/navbar.svelte";
    import { onMount } from "svelte";

    import "../../../app.css";

    /** @type {import('./$types').PageData} */
	  export let data;
    export let vuln;

    export function getCVSSMetric(metrics) {
        const regexPattern = /^cvssMetricV(\d+)$/;

        for (const key in metrics) {
            if (metrics.hasOwnProperty(key) && regexPattern.test(key)) {
                return metrics[key];
            }
        }

        return null;
    }

    export function getMetricInfo(value) {
      if (value < 5 && value > 0) return {color: "my_lime_400", label: "LOW"};
      else if (value >= 4 && value < 8) return { color: "my_orange_300", label: "MEDIUM" };
      else if (value >= 8 && value <= 10) return { color: "my_red_400", label: "CRITICAL" };
      else return { color: "my_gray_400", label: "" };
    }

    onMount(async () => {
      let cacheLifetime = 120000;
      let currentTime = new Date().getTime();

      let localData = localStorage.getItem(`${data.params}`);
      let isLocalDataValid = false

      if (localData) {
        let vulnData = JSON.parse(localData);
        vuln = vulnData.vulnerabilities[0];
        isLocalDataValid = currentTime - vulnData.timestamp < cacheLifetime;
      }

      if (!isLocalDataValid) {
        const res = await fetch(`https://services.nvd.nist.gov/rest/json/cves/2.0/?cveId=${data.params}`);
        let req_data = await res.json();

        localStorage.setItem(`${data.params}`, JSON.stringify({ ...req_data, timestamp: currentTime }));
        vuln = req_data.vulnerabilities[0];
      }
      console.log(vuln);

    });
</script>

<div class="body bg-my_zinc_600 flex flex-col min-h-screen">
    <div class="flex-grow">
        <div class="Frame2 w-[1920px] relative">
          <!-- NAVBAR -->
          <Navbar />
    
          { #if vuln }
          <div class="IdDetail left-[75px] top-[224px] absolute text-black text-[40px] font-bold font-['Kaisei Opti']"><i class="fa fa-bug text-7xl"></i> { vuln.cve.id } Detail</div>
    
          <!-- Quick Info -->
          <div class="QuickInfoGroup w-80 h-[408.95px] left-[1533px] top-[496px] absolute">
            <div class="Rectangle17 w-80 h-[408.95px] left-0 top-0 absolute bg-my_neutral_700 rounded-[30px] shadow"></div>
            <div class="Rectangle16 w-[313px] h-[400px] left-0 top-0 absolute bg-my_neutral_700 rounded-[30px] shadow">
            </div>
            <div class="Barra2 w-[263px] h-[57px] left-[25px] top-[40px] absolute bg-my_zinc_700 rounded-[40px] shadow">
            </div>
            <div class="QuickInfo left-[65px] top-[47px] absolute text-my_gray_400 text-3xl font-bold font-['Kaisei Opti']">
              QUICK
              INFO</div>
            <div
              class="Text left-[28px] top-[124px] absolute text-my_indigo_500 underline text-xl font-bold font-['Kaisei Opti']">
              <div>
                <a href="/">Description</a>
              </div>
              <div>
                <a href="/">Severity</a>
              </div>
              <div>
                <a href="/">Refernces to Advisories, Solutions, and Tools</a>
              </div>
              <div>
                <a href="/">Weakness Enumeration</a>
              </div>
              <div>
                <a href="/">Known Affected Software Configurations</a>
              </div>
            </div>
          </div>
    
          <!-- Description -->
          <div class="relative w-[1360px] min-h-[110px] left-[57px] top-[416px] bg-my_neutral_700 rounded-[44px] shadow">
            <div class="relative left-[30px] bottom-[50px]">
              <div class="Barra2 w-[299px] h-[57px] left-[7px] top-[10px] absolute bg-my_neutral_700 rounded-[40px] shadow">
              </div>
              <div class="Barra2 w-[299px] h-[57px] absolute bg-my_zinc_700 rounded-[40px] shadow"></div>
    
              <div
                class="Severity w-[202px] left-[70px] top-0 absolute text-my_gray_400 text-[35px] font-bold font-['Kaisei Opti']">
                Description</div>
            </div>
    
            <div class="Text text-my_gray_400 text-xl font-['Kaisei Opti'] w-fit p-5">
              { vuln.cve.descriptions[0].value }
            </div>
          </div>
    
          <!-- Severity -->
          <div class="Group1 w-[1309px] h-[542px] left-[57px] top-[500px] relative">
            <div class="relative left-[30px]">
              <div class="Barra2 w-[299px] h-[57px] left-[7px] top-[10px] absolute bg-my_neutral_700 rounded-[40px] shadow">
              </div>
              <div class="Barra2 w-[299px] h-[57px] absolute bg-my_zinc_700 rounded-[40px] shadow"></div>
    
              <div
                class="Severity w-[202px] left-[90px] top-0 absolute text-my_gray_400 text-[35px] font-bold font-['Kaisei Opti']">
                Severity</div>
            </div>
    
            <div class="Barra2 w-[1301px] h-[483px] left-[8px] top-[59px] absolute bg-my_neutral_700 rounded-[40px] shadow">
            </div>
            <div class="Barra2 w-[1301px] h-[483px] left-0 top-[51px] absolute bg-my_neutral_700 rounded-[40px] shadow">
            </div>
            <div
              class="Rectangle18 w-[184.02px] h-[200px] left-[147.21px] top-[177px] absolute bg-{ getMetricInfo(getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].cvssData.baseScore : null).color } rounded-xl shadow">
            </div>
            <div
              class="Critical w-[227px] left-[170px] top-[324px] absolute text-black text-3xl font-bold font-['Kaisei Opti']">
              { getMetricInfo(getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].cvssData.baseScore : null).label }</div>
            <div
              class="Rectangle19 w-[184.02px] h-[200px] left-[558.49px] top-[177px] absolute bg-{ getMetricInfo(getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].impactScore : null).color } rounded-xl shadow">
            </div>
            <div
              class="Rectangle20 w-[184.02px] h-[200px] left-[969.77px] top-[177px] absolute bg-{ getMetricInfo(getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].exploitabilityScore : null).color } rounded-xl shadow">
            </div>
            <div
              class="Score w-[182px] h-[81px] left-[191px] top-[393px] absolute text-my_gray_400 text-[37px] font-bold font-['Kaisei Opti']">
              Score</div>
            <div
              class="Critical w-[179px] left-[585px] top-[324px] absolute text-black text-3xl font-bold font-['Kaisei Opti']">
              { getMetricInfo(getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].impactScore : null).label }</div>
            <div
              class="Critical w-[252px] left-[1000px] top-[324px] absolute text-black text-3xl font-bold font-['Kaisei Opti']">
              { getMetricInfo(getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].exploitabilityScore : null).label }</div>
            <div
              class="ImpactScore w-[305px] left-[537px] top-[393px] absolute text-my_gray_400 text-[37px] font-bold font-['Kaisei Opti']">
              Impact Score</div>
            <div
              class="Exploitability w-[277px] left-[933px] top-[393px] absolute text-my_gray_400 text-[37px] font-bold font-['Kaisei Opti']">
              Exploitability</div>
            <div
              class="8 w-[145px] left-[165px] top-[209px] absolute flex justify-center items-center text-black text-[75px] font-bold font-['Kaisei Opti']">
              { getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].cvssData.baseScore : "N/A" }</div>
            <div
              class="8 w-[162px] left-[570px] top-[209px] absolute flex justify-center items-center text-black text-[75px] font-bold font-['Kaisei Opti']">
              { getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].impactScore : "N/A" }</div>
            <div
              class="8 w-[138px] left-[990px] top-[209px] absolute flex justify-center items-center text-black text-[75px] font-bold font-['Kaisei Opti']">
              { getCVSSMetric(vuln.cve.metrics) ? getCVSSMetric(vuln.cve.metrics)[0].exploitabilityScore : "N/A" }</div>
          </div>
    
          <!-- Refernces to Advisories, Solutions, and Tools -->
          <div class="relative w-[1360px] min-h-[110px] left-[57px] top-[616px] bg-my_neutral_700 rounded-[44px] shadow">
            <div class="relative left-[30px] bottom-[50px]">
    
              <div class="Barra2 w-[850px] h-[57px] left-[7px] top-[10px] absolute bg-my_neutral_700 rounded-[40px] shadow">
              </div>
              <div class="Barra2 w-[850px] h-[57px] absolute bg-my_zinc_700 rounded-[40px] shadow"></div>
    
              <div
                class="Severity min-w-[202px] left-[70px] top-0 absolute text-my_gray_400 text-[35px] font-bold font-['Kaisei Opti']">
                Refernces to Advisories, Solutions, and Tools</div>
            </div>
    
            <div class="Text text-my_gray_400 text-xl font-['Kaisei Opti'] w-fit p-5">
              By selecting these links, you will be leaving NIST webspace. We have provided these links to other web sites
              because they may have information that would be of interest to you. No inferences should be drawn on account
              of other sites being referenced, or not, from this page. There may be other web sites that are more
              appropriate for your purpose. NIST does not necessarily endorse the views expressed, or concur with the facts
              presented on these sites. Further, NIST does not endorse any commercial products that may be mentioned on
              these sites. Please address comments about this page to nvd@nist.gov.
            </div>
          </div>
    
          <!-- Weakness Enumeration -->
          <div class="relative w-[1360px] min-h-[110px] left-[57px] top-[732px] bg-my_neutral_700 rounded-[44px] shadow">
            <div class="relative left-[30px] bottom-[50px]">
              <div class="Barra2 w-[500px] h-[57px] left-[7px] top-[10px] absolute bg-my_neutral_700 rounded-[40px] shadow">
              </div>
              <div class="Barra2 w-[500px] h-[57px] absolute bg-my_zinc_700 rounded-[40px] shadow"></div>
    
              <div
                class="Severity min-w-[202px] left-[70px] top-0 absolute text-my_gray_400 text-[35px] font-bold font-['Kaisei Opti']">
                Weakness Enumeration</div>
            </div>
    
            <div class="Text text-my_gray_400 text-xl font-['Kaisei Opti'] w-fit p-5">
              The WooCommerce Ninja Forms Product Add-ons WordPress plugin before 1.7.1 does not validate the file to be
              uploaded, allowing any unauthenticated users to upload arbitrary files to the server, leading to RCE.
            </div>
          </div>
    
          <!-- Known Affected Software Configurations -->
          <div class="relative w-[1360px] min-h-[110px] left-[57px] top-[848px] bg-my_neutral_700 rounded-[44px] shadow">
            <div class="relative left-[30px] bottom-[50px]">
              <div class="Barra2 w-[800px] h-[57px] left-[7px] top-[10px] absolute bg-my_neutral_700 rounded-[40px] shadow">
              </div>
              <div class="Barra2 w-[800px] h-[57px] absolute bg-my_zinc_700 rounded-[40px] shadow"></div>
    
              <div
                class="Severity min-w-[202px] left-[70px] top-0 absolute text-my_gray_400 text-[35px] font-bold font-['Kaisei Opti']">
                Known Affected Software Configurations</div>
            </div>
    
            <div class="Text text-my_gray_400 text-xl font-['Kaisei Opti'] w-fit p-5">
              The WooCommerce Ninja Forms Product Add-ons WordPress plugin before 1.7.1 does not validate the file to be
              uploaded, allowing any unauthenticated users to upload arbitrary files to the server, leading to RCE.
            </div>
          </div>
          { /if }
        </div>
      </div>
      <div class="h-[1000px]"></div>
</div>
